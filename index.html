<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuaderno Económico - Bs. (Cloud)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .section { margin-bottom: 30px; }
        .moneda { font-weight: bold; color: #2c3e50; }
        .btn-sm { font-size: 0.75rem; }
        .categoria-badge { font-size: 0.7rem; }
        .informe { background: #e9ecef; padding: 15px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Cuaderno Económico (Bs.) - Cloud</h1>
        
        <!-- Estado de conexión -->
        <div id="estado" class="alert alert-info text-center">Conectando a la base de datos...</div>

        <!-- Dashboard -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between">
                <h5>Balance Actual</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="mostrarInforme()">Informe Mensual</button>
            </div>
            <div class="card-body text-center">
                <p class="h3 moneda" id="balance">Bs. 0,00</p>
                <small>Ingresos: <span class="moneda" id="totalIngresos">0</span> | Egresos: <span class="moneda" id="totalEgresos">0</span></small>
            </div>
        </div>

        <!-- Ingresos -->
        <div class="section">
            <h3>Ingresos</h3>
            <form id="formIngreso" class="row g-3 mb-3">
                <div class="col-md-3"><input type="date" class="form-control" id="fechaIngreso" required></div>
                <div class="col-md-5"><input type="text" class="form-control" id="descIngreso" placeholder="Descripción" required></div>
                <div class="col-md-3"><input type="number" class="form-control" id="montoIngreso" placeholder="Monto (Bs.)" step="0.01" required></div>
                <div class="col-md-1"><button type="submit" class="btn btn-success w-100">Agregar</button></div>
            </form>
            <table class="table table-striped" id="tablaIngresos">
                <thead><tr><th>Fecha</th><th>Descripción</th><th>Monto</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Egresos -->
        <div class="section">
            <h3>Egresos</h3>
            <div class="card mb-3">
                <div class="card-body">
                    <h6>Gestionar Categorías</h6>
                    <div class="row g-2">
                        <div class="col-md-5"><input type="text" class="form-control form-control-sm" id="nuevaCategoria" placeholder="Nueva categoría"></div>
                        <div class="col-md-3"><button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="agregarCategoria()">+ Agregar</button></div>
                    </div>
                    <div class="mt-2" id="listaCategorias"></div>
                </div>
            </div>

            <form id="formEgreso" class="row g-3 mb-3">
                <div class="col-md-3"><input type="date" class="form-control" id="fechaEgreso" required></div>
                <div class="col-md-3"><select class="form-control" id="categoriaEgreso" required></select></div>
                <div class="col-md-4"><input type="text" class="form-control" id="descEgreso" placeholder="Descripción" required></div>
                <div class="col-md-2"><input type="number" class="form-control" id="montoEgreso" placeholder="Monto (Bs.)" step="0.01" required></div>
                <div class="col-12 text-end"><button type="submit" class="btn btn-danger">Agregar Egreso</button></div>
            </form>

            <table class="table table-striped" id="tablaEgresos">
                <thead><tr><th>Fecha</th><th>Categoría</th><th>Descripción</th><th>Monto</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Recordatorios -->
        <div class="section">
            <h3>Recordatorios</h3>
            <form id="formRecordatorio" class="row g-3 mb-3">
                <div class="col-md-3"><input type="date" class="form-control" id="fechaRecordatorio" required></div>
                <div class="col-md-5"><input type="text" class="form-control" id="descRecordatorio" placeholder="Ej: Pago luz" required></div>
                <div class="col-md-3"><input type="number" class="form-control" id="montoRecordatorio" placeholder="Monto (Bs.)" step="0.01"></div>
                <div class="col-md-1"><button type="submit" class="btn btn-warning w-100">Agregar</button></div>
            </form>
            <table class="table" id="tablaRecordatorios">
                <thead><tr><th>Vence</th><th>Descripción</th><th>Monto</th><th>Estado</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Informe Mensual (Oculto) -->
        <div id="seccionInforme" class="card mt-4" style="display:none;">
            <div class="card-header d-flex justify-content-between">
                <h5>Informe Mensual: <span id="mesInforme"></span></h5>
                <button class="btn btn-sm btn-success" onclick="exportarCSV()">Exportar CSV</button>
            </div>
            <div class="card-body informe">
                <div id="resumenInforme"></div>
                <table class="table mt-3" id="tablaInforme">
                    <thead><tr><th>Tipo</th><th>Descripción</th><th>Categoría</th><th>Monto</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // REEMPLAZA ESTO CON TU CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Inicializar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Colecciones
        const colIngresos = collection(db, "ingresos");
        const colEgresos = collection(db, "egresos");
        const colRecordatorios = collection(db, "recordatorios");
        const colCategorias = collection(db, "categorias");

        // Estado
        let ingresos = [], egresos = [], recordatorios = [], categorias = [
            "Servicios Básicos", "Impuestos Municipales", "Impuestos Mensuales", "Impuestos Trimestrales", "Otros"
        ];

        // Formatear Bs.
        function formatoBs(valor) {
            const num = parseFloat(valor) || 0;
            return 'Bs. ' + num.toLocaleString('es-BO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Escuchar datos en tiempo real
        onSnapshot(colIngresos, snap => { ingresos = snap.docs.map(d => ({id: d.id, ...d.data()})); renderAll(); });
        onSnapshot(colEgresos, snap => { egresos = snap.docs.map(d => ({id: d.id, ...d.data()})); renderAll(); });
        onSnapshot(colRecordatorios, snap => { recordatorios = snap.docs.map(d => ({id: d.id, ...d.data()})); renderAll(); });
        onSnapshot(colCategorias, snap => {
            const cats = snap.docs.map(d => d.data().nombre);
            categorias = cats.length > 0 ? cats : categorias;
            renderSelectCategorias();
            renderListaCategorias();
        });

        // Renderizar todo
        function renderAll() {
            calcularBalance();
            renderIngresos();
            renderEgresos();
            renderRecordatorios();
            document.getElementById('estado').textContent = 'Conectado a la nube';
            document.getElementById('estado').className = 'alert alert-success text-center';
        }

        // Balance
        function calcularBalance() {
            const totalIn = ingresos.reduce((s, i) => s + parseFloat(i.monto || 0), 0);
            const totalEg = egresos.reduce((s, e) => s + parseFloat(e.monto || 0), 0);
            const balance = totalIn - totalEg;
            document.getElementById('totalIngresos').textContent = formatoBs(totalIn);
            document.getElementById('totalEgresos').textContent = formatoBs(totalEg);
            document.getElementById('balance').textContent = formatoBs(balance);
            document.getElementById('balance').className = balance >= 0 ? 'h3 moneda text-success' : 'h3 moneda text-danger';
        }

        // Renderizar tablas
        function renderIngresos() {
            const tbody = document.querySelector('#tablaIngresos tbody');
            tbody.innerHTML = ingresos.map(i => `
                <tr>
                    <td>${i.fecha}</td>
                    <td>${i.desc}</td>
                    <td class="moneda">${formatoBs(i.monto)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="eliminar('ingresos', '${i.id}')">Eliminar</button></td>
                </tr>
            `).join('');
        }

        function renderEgresos() {
            const tbody = document.querySelector('#tablaEgresos tbody');
            tbody.innerHTML = egresos.map(e => `
                <tr>
                    <td>${e.fecha}</td>
                    <td><span class="badge bg-info">${e.categoria}</span></td>
                    <td>${e.desc}</td>
                    <td class="moneda">${formatoBs(e.monto)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editarEgreso('${e.id}', '${e.fecha}', '${e.categoria}', '${e.desc}', '${e.monto}')">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminar('egresos', '${e.id}')">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecordatorios() {
            const hoy = new Date().toISOString().split('T')[0];
            const tbody = document.querySelector('#tablaRecordatorios tbody');
            tbody.innerHTML = recordatorios.map(r => {
                const vencido = r.fecha <= hoy && !r.pagado;
                return `
                    <tr class="${vencido ? 'table-warning' : ''}">
                        <td>${r.fecha}</td>
                        <td>${r.desc}</td>
                        <td class="moneda">${r.monto ? formatoBs(r.monto) : 'N/A'}</td>
                        <td><span class="badge ${r.pagado ? 'bg-success' : 'bg-warning'}">${r.pagado ? 'Pagado' : 'Pendiente'}</span></td>
                        <td>
                            ${!r.pagado ? `<button class="btn btn-sm btn-success" onclick="marcarPagado('${r.id}')">Pagar</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="eliminar('recordatorios', '${r.id}')">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Categorías
        function renderSelectCategorias() {
            const select = document.getElementById('categoriaEgreso');
            select.innerHTML = categorias.map(c => `<option>${c}</option>`).join('');
        }

        function renderListaCategorias() {
            const cont = document.getElementById('listaCategorias');
            cont.innerHTML = categorias.map((c, i) => `
                <span class="badge bg-secondary me-1 mb-1">
                    ${c}
                    <button type="button" class="btn-close btn-close-white btn-sm ms-1" onclick="eliminarCategoria('${c}')"></button>
                </span>
            `).join('');
        }

        async function agregarCategoria() {
            const nombre = document.getElementById('nuevaCategoria').value.trim();
            if (nombre && !categorias.includes(nombre)) {
                await addDoc(colCategorias, { nombre });
                document.getElementById('nuevaCategoria').value = '';
            }
        }

        async function eliminarCategoria(nombre) {
            if (confirm(`¿Eliminar categoría "${nombre}"?`)) {
                const q = query(colCategorias, where("nombre", "==", nombre));
                const snap = await getDocs(q);
                snap.forEach(d => deleteDoc(doc(db, "categorias", d.id)));
            }
        }

        // CRUD
        window.agregarIngreso = async () => {
            const f = document.getElementById('formIngreso');
            await addDoc(colIngresos, {
                fecha: f.fechaIngreso.value,
                desc: f.descIngreso.value,
                monto: f.montoIngreso.value
            });
            f.reset();
        };

        window.agregarEgreso = async () => {
            const f = document.getElementById('formEgreso');
            await addDoc(colEgresos, {
                fecha: f.fechaEgreso.value,
                categoria: f.categoriaEgreso.value,
                desc: f.descEgreso.value,
                monto: f.montoEgreso.value
            });
            f.reset();
        };

        window.agregarRecordatorio = async () => {
            const f = document.getElementById('formRecordatorio');
            await addDoc(colRecordatorios, {
                fecha: f.fechaRecordatorio.value,
                desc: f.descRecordatorio.value,
                monto: f.montoRecordatorio.value || null,
                pagado: false
            });
            f.reset();
        };

        window.eliminar = async (coleccion, id) => {
            if (confirm('¿Eliminar?')) {
                await deleteDoc(doc(db, coleccion, id));
            }
        };

        window.editarEgreso = async (id, fecha, cat, desc, monto) => {
            const nFecha = prompt('Fecha:', fecha);
            const nCat = prompt('Categoría:', cat);
            const nDesc = prompt('Descripción:', desc);
            const nMonto = prompt('Monto:', monto);
            if (nFecha && nCat && nDesc && nMonto) {
                await updateDoc(doc(db, "egresos", id), {
                    fecha: nFecha, categoria: nCat, desc: nDesc, monto: nMonto
                });
            }
        };

        window.marcarPagado = async (id) => {
            const rec = recordatorios.find(r => r.id === id);
            await updateDoc(doc(db, "recordatorios", id), { pagado: true });
            if (rec.monto) {
                await addDoc(colEgresos, {
                    fecha: rec.fecha,
                    categoria: "Pago Recordatorio",
                    desc: rec.desc,
                    monto: rec.monto
                });
            }
        };

        // Informe Mensual
        window.mostrarInforme = () => {
            const hoy = new Date();
            const mes = hoy.getMonth();
            const año = hoy.getFullYear();
            const mesStr = hoy.toLocaleDateString('es-BO', { month: 'long', year: 'numeric' });
            document.getElementById('mesInforme').textContent = mesStr;
            document.getElementById('seccionInforme').style.display = 'block';

            const desde = `${año}-${String(mes+1).padStart(2, '0')}-01`;
            const hasta = `${año}-${String(mes+1).padStart(2, '0')}-31`;

            const ingMes = ingresos.filter(i => i.fecha >= desde && i.fecha <= hasta);
            const egrMes = egresos.filter(e => e.fecha >= desde && e.fecha <= hasta);

            const totalIn = ingMes.reduce((s, i) => s + parseFloat(i.monto), 0);
            const totalEg = egrMes.reduce((s, e) => s + parseFloat(e.monto), 0);

            document.getElementById('resumenInforme').innerHTML = `
                <p><strong>Ingresos:</strong> ${formatoBs(totalIn)}</p>
                <p><strong>Egresos:</strong> ${formatoBs(totalEg)}</p>
                <p><strong>Balance:</strong> ${formatoBs(totalIn - totalEg)}</p>
            `;

            const tbody = document.querySelector('#tablaInforme tbody');
            tbody.innerHTML = [
                ...ingMes.map(i => `<tr><td>Ingreso</td><td>${i.desc}</td><td>-</td><td>${formatoBs(i.monto)}</td></tr>`),
                ...egrMes.map(e => `<tr><td>Egreso</td><td>${e.desc}</td><td>${e.categoria}</td><td>${formatoBs(e.monto)}</td></tr>`)
            ].join('');
        };

        // Exportar CSV
        window.exportarCSV = () => {
            const rows = [
                ["Tipo", "Fecha", "Descripción", "Categoría", "Monto"],
                ...ingresos.map(i => ["Ingreso", i.fecha, i.desc, "", i.monto]),
                ...egresos.map(e => ["Egreso", e.fecha, e.desc, e.categoria, e.monto])
            ];
            const csv = rows.map(r => r.join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `informe_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        };

        // Eventos
        document.getElementById('formIngreso').onsubmit = (e) => { e.preventDefault(); agregarIngreso(); };
        document.getElementById('formEgreso').onsubmit = (e) => { e.preventDefault(); agregarEgreso(); };
        document.getElementById('formRecordatorio').onsubmit = (e) => { e.preventDefault(); agregarRecordatorio(); };

        // Fecha hoy
        document.querySelectorAll('input[type="date"]').forEach(i => i.valueAsDate = new Date());
    </script>
</body>
</html>