<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuaderno Económico - Bs.</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .section { margin-bottom: 30px; }
        .moneda { font-weight: bold; color: #2c3e50; }
        .btn-sm { font-size: 0.75rem; }
        .categoria-badge { font-size: 0.7rem; }
        .alert-pending { background-color: #fff3cd; }
        .alert-paid { background-color: #d1e7dd; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Cuaderno Económico (Bs.)</h1>
        
        <!-- Dashboard de Balance -->
        <div class="card mb-4">
            <div class="card-header"><h5>Balance Actual</h5></div>
            <div class="card-body text-center">
                <p class="h3 moneda" id="balance">Bs. 0,00</p>
                <small>Ingresos: <span class="moneda" id="totalIngresos">Bs. 0,00</span> | Egresos: <span class="moneda" id="totalEgresos">Bs. 0,00</span></small>
            </div>
        </div>

        <!-- Sección Ingresos -->
        <div class="section">
            <h3>Ingresos</h3>
            <form id="formIngreso" class="row g-3 mb-3">
                <div class="col-md-3">
                    <input type="date" class="form-control" id="fechaIngreso" required>
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" id="descIngreso" placeholder="Descripción" required>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" id="montoIngreso" placeholder="Monto (Bs.)" step="0.01" required>
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-success w-100">Agregar</button>
                </div>
            </form>
            <table class="table table-striped" id="tablaIngresos">
                <thead><tr><th>Fecha</th><th>Descripción</th><th>Monto</th><th>Acción</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Sección Egresos -->
        <div class="section">
            <h3>Egresos</h3>

            <!-- Gestionar Categorías -->
            <div class="card mb-3">
                <div class="card-body">
                    <h6 class="card-title mb-2">Gestionar Categorías</h6>
                    <div class="row g-2 align-items-center">
                        <div class="col-md-5">
                            <input type="text" class="form-control form-control-sm" id="nuevaCategoria" placeholder="Nueva categoría (ej: Netflix)">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-outline-primary btn-sm w-100" onclick="agregarCategoria()">+ Agregar</button>
                        </div>
                    </div>
                    <div class="mt-2" id="listaCategorias"></div>
                </div>
            </div>

            <!-- Formulario de Egreso -->
            <form id="formEgreso" class="row g-3 mb-3">
                <div class="col-md-3">
                    <input type="date" class="form-control" id="fechaEgreso" required>
                </div>
                <div class="col-md-3">
                    <select class="form-control" id="categoriaEgreso" required></select>
                </div>
                <div class="col-md-4">
                    <input type="text" class="form-control" id="descEgreso" placeholder="Descripción" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control" id="montoEgreso" placeholder="Monto (Bs.)" step="0.01" required>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-danger">Agregar Egreso</button>
                </div>
            </form>

            <table class="table table-striped" id="tablaEgresos">
                <thead><tr><th>Fecha</th><th>Categoría</th><th>Descripción</th><th>Monto</th><th>Acciones</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Sección Recordatorios -->
        <div class="section">
            <h3>Recordatorios: Pagos y Cancelaciones</h3>
            <form id="formRecordatorio" class="row g-3 mb-3">
                <div class="col-md-3">
                    <input type="date" class="form-control" id="fechaRecordatorio" required>
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" id="descRecordatorio" placeholder="Ej: Pago luz, Impuesto municipal" required>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control" id="montoRecordatorio" placeholder="Monto estimado (Bs.)" step="0.01">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-warning w-100">Agregar</button>
                </div>
            </form>
            <table class="table" id="tablaRecordatorios">
                <thead><tr><th>Fecha Venc.</th><th>Descripción</th><th>Monto Est.</th><th>Estado</th><th>Acción</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // Formatear número como Bs.
        function formatoBs(valor) {
            if (isNaN(valor)) return 'Bs. 0,00';
            const num = parseFloat(valor);
            return 'Bs. ' + num.toLocaleString('es-BO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Datos (localStorage)
        let ingresos = JSON.parse(localStorage.getItem('ingresos')) || [];
        let egresos = JSON.parse(localStorage.getItem('egresos')) || [];
        let recordatorios = JSON.parse(localStorage.getItem('recordatorios')) || [];
        let categoriasEgresos = JSON.parse(localStorage.getItem('categoriasEgresos')) || [
            "Servicios Básicos", "Impuestos Municipales", "Impuestos Mensuales", 
            "Impuestos Trimestrales", "Otros"
        ];

        // Guardar datos
        function guardarDatos() {
            localStorage.setItem('ingresos', JSON.stringify(ingresos));
            localStorage.setItem('egresos', JSON.stringify(egresos));
            localStorage.setItem('recordatorios', JSON.stringify(recordatorios));
            localStorage.setItem('categoriasEgresos', JSON.stringify(categoriasEgresos));
        }

        // Categorías
        function renderSelectCategorias() {
            const select = document.getElementById('categoriaEgreso');
            select.innerHTML = categoriasEgresos.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function renderListaCategorias() {
            const cont = document.getElementById('listaCategorias');
            cont.innerHTML = categoriasEgresos.map((cat, idx) => `
                <span class="badge bg-secondary me-1 mb-1 categoria-badge">
                    ${cat}
                    <button type="button" class="btn-close btn-close-white btn-sm ms-1" onclick="eliminarCategoria(${idx})" title="Eliminar"></button>
                </span>
            `).join('');
        }

        function agregarCategoria() {
            const input = document.getElementById('nuevaCategoria');
            const nombre = input.value.trim();
            if (nombre && !categoriasEgresos.includes(nombre)) {
                categoriasEgresos.push(nombre);
                categoriasEgresos.sort();
                guardarDatos();
                renderSelectCategorias();
                renderListaCategorias();
                input.value = '';
            } else if (nombre) {
                alert('Categoría ya existe o inválida.');
            }
        }

        function eliminarCategoria(idx) {
            if (confirm(`¿Eliminar "${categoriasEgresos[idx]}"?`)) {
                categoriasEgresos.splice(idx, 1);
                guardarDatos();
                renderSelectCategorias();
                renderListaCategorias();
            }
        }

        // Balance
        function calcularBalance() {
            const totalIn = ingresos.reduce((sum, i) => sum + parseFloat(i.monto || 0), 0);
            const totalEg = egresos.reduce((sum, e) => sum + parseFloat(e.monto || 0), 0);
            const balance = totalIn - totalEg;
            document.getElementById('totalIngresos').textContent = formatoBs(totalIn);
            document.getElementById('totalEgresos').textContent = formatoBs(totalEg);
            document.getElementById('balance').textContent = formatoBs(balance);
            document.getElementById('balance').className = balance >= 0 ? 'h3 moneda text-success' : 'h3 moneda text-danger';
        }

        // Renderizar tablas
        function renderIngresos() {
            const tbody = document.querySelector('#tablaIngresos tbody');
            tbody.innerHTML = ingresos.map((ing, idx) => `
                <tr>
                    <td>${ing.fecha}</td>
                    <td>${ing.desc}</td>
                    <td class="moneda">${formatoBs(ing.monto)}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="eliminarIngreso(${idx})">Eliminar</button></td>
                </tr>
            `).join('');
        }

        function renderEgresos() {
            const tbody = document.querySelector('#tablaEgresos tbody');
            tbody.innerHTML = egresos.map((egr, idx) => `
                <tr>
                    <td>${egr.fecha}</td>
                    <td><span class="badge bg-info">${egr.categoria}</span></td>
                    <td>${egr.desc}</td>
                    <td class="moneda">${formatoBs(egr.monto)}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editarEgreso(${idx})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarEgreso(${idx})">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderRecordatorios() {
            const hoy = new Date().toISOString().split('T')[0];
            const tbody = document.querySelector('#tablaRecordatorios tbody');
            tbody.innerHTML = recordatorios.map((rec, idx) => {
                const esVencido = rec.fecha <= hoy && !rec.pagado;
                const clase = rec.pagado ? 'alert-paid' : (esVencido ? 'alert-pending' : '');
                return `
                    <tr class="${clase}">
                        <td>${rec.fecha}</td>
                        <td>${rec.desc}</td>
                        <td class="moneda">${rec.monto ? formatoBs(rec.monto) : 'N/A'}</td>
                        <td><span class="badge ${rec.pagado ? 'bg-success' : 'bg-warning'}">${rec.pagado ? 'Pagado' : 'Pendiente'}</span></td>
                        <td>
                            ${!rec.pagado ? `<button class="btn btn-sm btn-success" onclick="marcarPagado(${idx})">Pagar</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="eliminarRecordatorio(${idx})">Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Eventos de formularios
        document.getElementById('formIngreso').addEventListener('submit', (e) => {
            e.preventDefault();
            const nuevo = {
                fecha: document.getElementById('fechaIngreso').value,
                desc: document.getElementById('descIngreso').value,
                monto: document.getElementById('montoIngreso').value
            };
            ingresos.push(nuevo);
            guardarDatos();
            renderIngresos();
            calcularBalance();
            e.target.reset();
        });

        document.getElementById('formEgreso').addEventListener('submit', (e) => {
            e.preventDefault();
            const nuevo = {
                fecha: document.getElementById('fechaEgreso').value,
                categoria: document.getElementById('categoriaEgreso').value,
                desc: document.getElementById('descEgreso').value,
                monto: document.getElementById('montoEgreso').value
            };
            egresos.push(nuevo);
            guardarDatos();
            renderEgresos();
            calcularBalance();
            e.target.reset();
        });

        document.getElementById('formRecordatorio').addEventListener('submit', (e) => {
            e.preventDefault();
            const nuevo = {
                fecha: document.getElementById('fechaRecordatorio').value,
                desc: document.getElementById('descRecordatorio').value,
                monto: document.getElementById('montoRecordatorio').value || null,
                pagado: false
            };
            recordatorios.push(nuevo);
            guardarDatos();
            renderRecordatorios();
            e.target.reset();
        });

        // Acciones
        function eliminarIngreso(idx) {
            if (confirm('¿Eliminar este ingreso?')) {
                ingresos.splice(idx, 1);
                guardarDatos();
                renderIngresos();
                calcularBalance();
            }
        }

        function eliminarEgreso(idx) {
            if (confirm('¿Eliminar este egreso?')) {
                egresos.splice(idx, 1);
                guardarDatos();
                renderEgresos();
                calcularBalance();
            }
        }

        function editarEgreso(idx) {
            const egr = egresos[idx];
            const nuevoFecha = prompt('Fecha (YYYY-MM-DD):', egr.fecha);
            const nuevoDesc = prompt('Descripción:', egr.desc);
            const nuevoMonto = prompt('Monto (Bs.):', egr.monto);
            const nuevaCat = prompt('Categoría:', egr.categoria);
            if (nuevoFecha && nuevoDesc && nuevoMonto && nuevaCat) {
                egresos[idx] = { fecha: nuevoFecha, categoria: nuevaCat, desc: nuevoDesc, monto: nuevoMonto };
                guardarDatos();
                renderEgresos();
                calcularBalance();
            }
        }

        function eliminarRecordatorio(idx) {
            if (confirm('¿Eliminar este recordatorio?')) {
                recordatorios.splice(idx, 1);
                guardarDatos();
                renderRecordatorios();
            }
        }

        function marcarPagado(idx) {
            recordatorios[idx].pagado = true;
            guardarDatos();
            renderRecordatorios();
            if (recordatorios[idx].monto) {
                const egreso = {
                    fecha: recordatorios[idx].fecha,
                    categoria: 'Pago Recordatorio',
                    desc: recordatorios[idx].desc,
                    monto: recordatorios[idx].monto
                };
                egresos.push(egreso);
                guardarDatos();
                renderEgresos();
                calcularBalance();
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            renderSelectCategorias();
            renderListaCategorias();
            calcularBalance();
            renderIngresos();
            renderEgresos();
            renderRecordatorios();
            // Fecha por defecto: hoy
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.valueAsDate = new Date();
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
